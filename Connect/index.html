<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HERO Sports Meet - Audio Conference</title>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Comfortaa:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/DsrGTPk/HERO-SPORTS-TALKS-removebg-preview.png">
    <style>
        /* CSS Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-black: #000000;
            --bg-dark: #0a0a0a;
            --bg-card: #1a1a1a;
            --text-white: #ffffff;
            --text-light: #e0e0e0;
            --text-gray: #888888;
            --border-light: rgba(255, 255, 255, 0.1);
            --border-medium: rgba(255, 255, 255, 0.2);
            --accent-red: #ff4444;
            --accent-yellow: #ffcc00;
            --accent-blue: #4a90e2;
            --speaking-glow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-black);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flex-col {
            flex-direction: column;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-black);
            z-index: 9999;
            flex-direction: column;
            gap: 2rem;
        }

        .loading-logo {
            width: 200px;
            height: auto;
            filter: brightness(0) invert(1);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--text-white);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Setup Screen */
        #setupScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-black);
            z-index: 9998;
            padding: 1rem;
            overflow-y: auto;
        }

        .setup-container {
            max-width: 500px;
            margin: 2rem auto;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2.5rem;
            border: 1px solid var(--border-light);
        }

        .setup-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .setup-logo {
            width: 150px;
            height: auto;
            filter: brightness(0) invert(1);
            margin-bottom: 1.5rem;
        }

        .setup-title {
            font-family: 'Comfortaa', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .setup-subtitle {
            color: var(--text-gray);
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            color: var(--text-white);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--text-white);
            background: rgba(255, 255, 255, 0.1);
        }

        .file-upload-area {
            border: 2px dashed var(--border-medium);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.02);
        }

        .file-upload-area:hover {
            border-color: var(--text-white);
            background: rgba(255, 255, 255, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--accent-blue);
            background: rgba(74, 144, 226, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--text-gray);
            margin-bottom: 1rem;
        }

        .upload-text {
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        #previewImage {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--text-white);
            margin: 1rem auto;
            display: none;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
            display: none;
        }

        .upload-progress-bar {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.3s;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }

        .btn-primary {
            background: var(--text-white);
            color: var(--bg-black);
        }

        .btn-primary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-danger {
            background: var(--accent-red);
            color: var(--text-white);
        }

        .btn-danger:hover {
            background: #ff3333;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-medium);
            color: var(--text-white);
        }

        .btn-outline:hover {
            border-color: var(--text-white);
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-icon {
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
            border: 1px solid var(--border-medium);
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Main App */
        #appContainer {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            z-index: 100;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .app-logo {
            height: 40px;
            width: auto;
            filter: brightness(0) invert(1);
        }

        .app-title {
            font-family: 'Comfortaa', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--text-white);
        }

        .user-badge {
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .user-badge.owner {
            background: var(--accent-red);
            color: var(--text-white);
        }

        .user-badge.admin {
            background: var(--accent-yellow);
            color: var(--bg-black);
        }

        .user-badge.speaker {
            background: var(--accent-blue);
            color: var(--text-white);
        }

        /* Participants Grid */
        .participants-container {
            padding: 6rem 2rem 2rem;
            height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .participant-card {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s;
            aspect-ratio: 4/3;
        }

        .participant-card.speaking {
            border-color: var(--text-white);
            box-shadow: var(--speaking-glow);
        }

        .participant-card.owner {
            border-color: var(--accent-red);
        }

        .participant-card.admin {
            border-color: var(--accent-yellow);
        }

        .participant-card.main-speaker {
            border-color: var(--accent-yellow);
        }

        .participant-card.guest {
            border-color: var(--border-medium);
        }

        .participant-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(15px) brightness(0.6);
            opacity: 0.5;
        }

        .participant-content {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 50%, transparent 100%);
        }

        .participant-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--text-white);
            margin-bottom: 1rem;
        }

        .participant-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .participant-role {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .audio-indicator {
            margin-top: 1rem;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .audio-level {
            height: 100%;
            width: 0%;
            background: var(--text-white);
            border-radius: 2px;
            transition: width 0.1s ease-out;
        }

        .message-bubble {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: var(--text-white);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            max-width: 90%;
            word-break: break-word;
            z-index: 10;
            border: 1px solid var(--border-light);
            animation: fadeInOut 7s forwards;
            backdrop-filter: blur(5px);
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Controls Bar */
        .controls-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: center;
            gap: 1rem;
            z-index: 100;
        }

        .controls-group {
            display: flex;
            gap: 1rem;
        }

        /* Sidebar */
        .app-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--border-light);
            z-index: 200;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .app-sidebar.active {
            right: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Participants List */
        .participants-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .participant-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .participant-item.speaking {
            border-color: var(--text-white);
        }

        .participant-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .participant-item-info {
            flex: 1;
        }

        .participant-item-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .participant-item-role {
            font-size: 0.75rem;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .participant-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Messages Panel */
        .messages-panel {
            display: none;
        }

        .messages-panel.active {
            display: flex;
            flex-direction: column;
        }

        .messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            border-left: 3px solid var(--text-white);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .message-text {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message-input {
            padding: 1rem;
            border-top: 1px solid var(--border-light);
        }

        .message-form {
            display: flex;
            gap: 0.5rem;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--border-light);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .modal-body {
            margin-bottom: 2rem;
            text-align: center;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
        }

        .modal-footer .btn {
            flex: 1;
        }

        /* Join Request Modal */
        .join-request-modal .modal {
            max-width: 300px;
        }

        .join-request-modal .requester-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .requester-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--text-white);
        }

        .requester-name {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Call Status */
        .call-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: 20px;
            border: 1px solid var(--border-light);
            text-align: center;
            z-index: 1000;
            display: none;
        }

        .call-status.active {
            display: block;
        }

        .call-status-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: pulse 2s infinite;
        }

        .call-status-text {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .call-status-subtext {
            color: var(--text-gray);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Notification */
        .notification-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        .notification {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--text-white);
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.error {
            border-left-color: var(--accent-red);
        }

        .notification.success {
            border-left-color: #00ff88;
        }

        .notification.warning {
            border-left-color: var(--accent-yellow);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
            }

            .app-title {
                font-size: 1.2rem;
            }

            .participants-container {
                padding: 5rem 1rem 1rem;
            }

            .participants-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }

            .participant-card {
                aspect-ratio: 3/4;
            }

            .controls-bar {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .controls-group {
                gap: 0.5rem;
            }

            .btn-icon {
                width: 45px;
                height: 45px;
            }

            .app-sidebar {
                width: 100%;
                right: -100%;
            }

            .modal {
                width: 95%;
                padding: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .setup-container {
                padding: 1.5rem;
                margin: 1rem;
            }

            .participants-grid {
                grid-template-columns: 1fr;
            }

            .participant-card {
                max-width: 300px;
                margin: 0 auto;
            }
        }

        /* Audio Wave Animation */
        .audio-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 20px;
            margin-top: 0.5rem;
        }

        .audio-bar {
            width: 3px;
            background: var(--text-white);
            border-radius: 2px;
            animation: audioWave 1s ease-in-out infinite;
        }

        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes audioWave {
            0%, 100% { height: 5px; }
            50% { height: 15px; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="flex-center flex-col">
        <img src="https://i.ibb.co/DsrGTPk/HERO-SPORTS-TALKS-removebg-preview.png" alt="HERO Sports" class="loading-logo">
        <div class="spinner"></div>
        <div style="color: var(--text-gray); margin-top: 1rem;">Initializing...</div>
    </div>

    <!-- Setup Screen -->
    <div id="setupScreen" class="hidden">
        <div class="setup-container">
            <div class="setup-header">
                <img src="https://i.ibb.co/DsrGTPk/HERO-SPORTS-TALKS-removebg-preview.png" alt="HERO Sports" class="setup-logo">
                <h1 class="setup-title">HERO Sports Meet</h1>
                <p class="setup-subtitle">Join the audio conference</p>
            </div>

            <form id="setupForm">
                <div class="form-group">
                    <label for="userName" class="form-label">Your Name</label>
                    <input type="text" id="userName" class="form-input" placeholder="Enter your name" required>
                </div>

                <div class="form-group">
                    <label for="userEmail" class="form-label">Email Address</label>
                    <input type="email" id="userEmail" class="form-input" placeholder="Enter your email" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Profile Photo</label>
                    <div id="fileUploadArea" class="file-upload-area">
                        <div class="upload-icon">
                            <i class='bx bx-cloud-upload'></i>
                        </div>
                        <div class="upload-text">Click or drag & drop to upload</div>
                        <div class="upload-hint">JPG, PNG up to 5MB</div>
                        <img id="previewImage" alt="Preview">
                        <div class="upload-progress" id="uploadProgress">
                            <div class="upload-progress-bar" id="uploadProgressBar"></div>
                        </div>
                    </div>
                    <input type="file" id="photoFile" accept="image/*" style="display: none;">
                    <input type="hidden" id="photoUrl">
                </div>

                <button type="submit" class="btn btn-primary" id="joinBtn" disabled>
                    <i class='bx bx-phone'></i> Join Conference
                </button>
            </form>
        </div>
    </div>

    <!-- Call Status -->
    <div id="callStatus" class="call-status">
        <div class="call-status-icon">
            <i class='bx bx-phone-call'></i>
        </div>
        <div class="call-status-text" id="callStatusText">Requesting to Join</div>
        <div class="call-status-subtext" id="callStatusSubtext">Waiting for host approval...</div>
    </div>

    <!-- Main App -->
    <div id="appContainer">
        <!-- Header -->
        <div class="app-header">
            <div class="header-left">
                <img src="https://i.ibb.co/DsrGTPk/HERO-SPORTS-TALKS-removebg-preview.png" alt="HERO Sports" class="app-logo">
                <span class="app-title">HERO Sports Meet</span>
            </div>
            <div class="user-info">
                <img id="currentUserAvatar" class="user-avatar" src="" alt="">
                <div>
                    <div id="currentUserName" style="font-weight: 500;"></div>
                    <div id="currentUserRole" class="user-badge"></div>
                </div>
            </div>
        </div>

        <!-- Participants Grid -->
        <div class="participants-container">
            <div class="participants-grid" id="participantsGrid">
                <!-- Participants will be added here -->
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-bar">
            <div class="controls-group">
                <button class="btn-icon" id="muteBtn" title="Mute">
                    <i class='bx bx-microphone'></i>
                </button>
                <button class="btn-icon" id="participantsBtn" title="Participants">
                    <i class='bx bx-user'></i>
                </button>
                <button class="btn-icon" id="messagesBtn" title="Messages">
                    <i class='bx bx-message'></i>
                </button>
                <button class="btn-icon" id="leaveBtn" title="Leave Call">
                    <i class='bx bx-log-out'></i>
                </button>
            </div>
            <div class="controls-group" id="adminControls" style="display: none;">
                <button class="btn-icon" id="settingsBtn" title="Settings">
                    <i class='bx bx-cog'></i>
                </button>
                <button class="btn btn-danger" id="endCallBtn" style="padding: 0.5rem 1.5rem;">
                    <i class='bx bx-phone-off'></i> End Call
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="app-sidebar" id="appSidebar">
            <div class="sidebar-header">
                <div class="sidebar-title" id="sidebarTitle">Participants</div>
                <button class="btn-icon" id="closeSidebarBtn">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="sidebar-content" id="sidebarContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Join Request Modal -->
    <div id="joinRequestModal" class="modal-overlay join-request-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Join Request</div>
            </div>
            <div class="modal-body">
                <div class="requester-info">
                    <img id="requesterAvatar" class="requester-avatar" src="" alt="">
                    <div class="requester-name" id="requesterName"></div>
                    <div>wants to join the conference</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="rejectRequestBtn">
                    <i class='bx bx-x'></i> Reject
                </button>
                <button class="btn btn-primary" id="acceptRequestBtn">
                    <i class='bx bx-check'></i> Accept
                </button>
            </div>
        </div>
    </div>

    <!-- End Call Modal -->
    <div id="endCallModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">End Conference</div>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to end the conference for everyone?</p>
                <p style="color: var(--text-gray); font-size: 0.9rem; margin-top: 0.5rem;">
                    This will disconnect all participants.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelEndCallBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmEndCallBtn">End Conference</button>
            </div>
        </div>
    </div>

    <!-- Leave Call Modal -->
    <div id="leaveCallModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Leave Call</div>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to leave the conference?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelLeaveBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmLeaveBtn">Leave</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <!-- Firebase & WebRTC Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.0/simplepeer.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEjkoZ6xNZbNHdW1QDddYrBTVXxHgnIRc",
            authDomain: "rosine-e-commerce.firebaseapp.com",
            databaseURL: "https://rosine-e-commerce-default-rtdb.firebaseio.com",
            projectId: "rosine-e-commerce",
            storageBucket: "rosine-e-commerce.firebasestorage.app",
            messagingSenderId: "143638702824",
            appId: "1:143638702824:web:faa956ee5b50c9766ab75d",
            measurementId: "G-4CWT0L3Y98"
        };

        // Initialize Firebase if not already initialized
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const database = firebase.database();

        // App State
        const ROOM_ID = 'hero_sports_conference';
        let userId = null;
        let userData = {};
        let userRole = 'guest';
        let localStream = null;
        let audioContext = null;
        let analyser = null;
        let peers = new Map();
        let isMuted = false; // Start unmuted as requested
        let isInCall = false;
        let currentRequest = null;

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const setupScreen = document.getElementById('setupScreen');
        const appContainer = document.getElementById('appContainer');
        const setupForm = document.getElementById('setupForm');
        const userNameInput = document.getElementById('userName');
        const userEmailInput = document.getElementById('userEmail');
        const photoFileInput = document.getElementById('photoFile');
        const photoUrlInput = document.getElementById('photoUrl');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const previewImage = document.getElementById('previewImage');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const joinBtn = document.getElementById('joinBtn');
        const callStatus = document.getElementById('callStatus');
        const callStatusText = document.getElementById('callStatusText');
        const callStatusSubtext = document.getElementById('callStatusSubtext');
        const participantsGrid = document.getElementById('participantsGrid');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserRole = document.getElementById('currentUserRole');
        const muteBtn = document.getElementById('muteBtn');
        const participantsBtn = document.getElementById('participantsBtn');
        const messagesBtn = document.getElementById('messagesBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const adminControls = document.getElementById('adminControls');
        const endCallBtn = document.getElementById('endCallBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const appSidebar = document.getElementById('appSidebar');
        const sidebarTitle = document.getElementById('sidebarTitle');
        const sidebarContent = document.getElementById('sidebarContent');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const joinRequestModal = document.getElementById('joinRequestModal');
        const requesterAvatar = document.getElementById('requesterAvatar');
        const requesterName = document.getElementById('requesterName');
        const rejectRequestBtn = document.getElementById('rejectRequestBtn');
        const acceptRequestBtn = document.getElementById('acceptRequestBtn');
        const endCallModal = document.getElementById('endCallModal');
        const cancelEndCallBtn = document.getElementById('cancelEndCallBtn');
        const confirmEndCallBtn = document.getElementById('confirmEndCallBtn');
        const leaveCallModal = document.getElementById('leaveCallModal');
        const cancelLeaveBtn = document.getElementById('cancelLeaveBtn');
        const confirmLeaveBtn = document.getElementById('confirmLeaveBtn');
        const notificationContainer = document.getElementById('notificationContainer');

        // Initialize App
        async function initApp() {
            try {
                // Check for saved user
                const savedUser = localStorage.getItem('hero_sports_user');
                if (savedUser) {
                    userData = JSON.parse(savedUser);
                    userId = userData.id;
                    
                    // Check if room exists and user is already in it
                    const userRef = database.ref(`rooms/${ROOM_ID}/participants/${userId}`);
                    const snapshot = await userRef.once('value');
                    
                    if (snapshot.exists()) {
                        // User was in a call, try to rejoin
                        const userDataFromDb = snapshot.val();
                        userRole = userDataFromDb.role;
                        isInCall = true;
                        await joinCall();
                    } else {
                        // Show setup screen
                        showSetupScreen();
                    }
                } else {
                    showSetupScreen();
                }
            } catch (error) {
                console.error('Init error:', error);
                showNotification('Failed to initialize app', 'error');
            }
        }

        // Show Setup Screen
        function showSetupScreen() {
            loadingScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            
            // Setup file upload
            setupFileUpload();
        }

        // Setup File Upload
        function setupFileUpload() {
            fileUploadArea.addEventListener('click', () => {
                photoFileInput.click();
            });

            photoFileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    photoFileInput.files = files;
                    handleFileSelect();
                }
            });
        }

        // Handle File Select
        async function handleFileSelect() {
            const file = photoFileInput.files[0];
            if (!file) return;

            // Validate file
            if (file.size > 5 * 1024 * 1024) {
                showNotification('File too large (max 5MB)', 'error');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Upload to ImgBB
            await uploadToImgBB(file);
        }

        // Upload to ImgBB
        async function uploadToImgBB(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                // Show progress
                uploadProgress.style.display = 'block';
                uploadProgressBar.style.width = '30%';
                
                // Upload to ImgBB using your API key
                const response = await fetch('https://api.imgbb.com/1/upload?key=a3983d6765c59eea03fe80394f720737', {
                    method: 'POST',
                    body: formData
                });
                
                uploadProgressBar.style.width = '70%';
                
                const data = await response.json();
                
                if (data.success) {
                    uploadProgressBar.style.width = '100%';
                    photoUrlInput.value = data.data.url;
                    joinBtn.disabled = false;
                    
                    setTimeout(() => {
                        uploadProgress.style.display = 'none';
                        uploadProgressBar.style.width = '0%';
                    }, 500);
                    
                    showNotification('Photo uploaded successfully', 'success');
                } else {
                    throw new Error(data.error?.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                uploadProgress.style.display = 'none';
                showNotification('Failed to upload photo', 'error');
                joinBtn.disabled = false;
            }
        }

        // Setup Form Submission
        setupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!photoUrlInput.value) {
                showNotification('Please upload a profile photo', 'error');
                return;
            }
            
            // Generate user ID
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Save user data
            userData = {
                id: userId,
                name: userNameInput.value.trim(),
                email: userEmailInput.value.trim(),
                photo: photoUrlInput.value,
                role: 'guest',
                isSpeaking: false,
                isMuted: false,
                joinedAt: Date.now()
            };
            
            localStorage.setItem('hero_sports_user', JSON.stringify(userData));
            
            // Request audio permission
            await requestAudioPermission();
            
            // Join the conference
            await joinConference();
        });

        // Request Audio Permission
        async function requestAudioPermission() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        channelCount: 1,
                        sampleRate: 48000
                    },
                    video: false
                });
                
                // Setup audio analysis
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(localStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                
                // Start unmuted as requested
                localStream.getAudioTracks()[0].enabled = true;
                isMuted = false;
                
            } catch (error) {
                console.error('Audio error:', error);
                showNotification('Microphone access required', 'error');
                throw error;
            }
        }

        // Join Conference
        async function joinConference() {
            setupScreen.classList.add('hidden');
            callStatus.classList.add('active');
            
            // Check if room exists
            const roomRef = database.ref(`rooms/${ROOM_ID}`);
            const snapshot = await roomRef.once('value');
            
            if (!snapshot.exists()) {
                // First user - create room as owner
                userRole = 'owner';
                userData.role = 'owner';
                
                await roomRef.set({
                    created: Date.now(),
                    owner: userId,
                    status: 'active',
                    settings: {
                        requireApproval: true
                    }
                });
                
                await joinCall();
                
            } else {
                // Room exists - send join request
                callStatusText.textContent = 'REQUESTING TO JOIN';
                callStatusSubtext.textContent = 'Waiting for host approval...';
                
                // Send join request
                const requestRef = database.ref(`rooms/${ROOM_ID}/requests/${userId}`);
                await requestRef.set({
                    ...userData,
                    requestedAt: Date.now()
                });
                
                // Listen for response
                requestRef.on('value', async (snap) => {
                    const request = snap.val();
                    if (!request) return;
                    
                    if (request.status === 'accepted') {
                        // Join call
                        userRole = 'guest';
                        userData.role = 'guest';
                        await joinCall();
                        requestRef.remove();
                        
                    } else if (request.status === 'rejected') {
                        // Show rejection message
                        callStatusText.textContent = 'Sorry, Call Cancelled';
                        callStatusSubtext.textContent = 'Your request was rejected by the host';
                        
                        setTimeout(() => {
                            callStatus.classList.remove('active');
                            showSetupScreen();
                        }, 3000);
                        
                        requestRef.remove();
                    }
                });
            }
        }

        // Join Call
        async function joinCall() {
            callStatus.classList.remove('active');
            
            // Update user data
            const userRef = database.ref(`rooms/${ROOM_ID}/participants/${userId}`);
            await userRef.set(userData);
            
            // Setup disconnect handler
            userRef.onDisconnect().remove();
            
            // Setup Firebase listeners
            setupFirebaseListeners();
            
            // Update UI
            updateUI();
            
            // Show app
            appContainer.style.display = 'block';
            
            // Setup WebRTC for existing participants
            await setupExistingConnections();
        }

        // Setup Firebase Listeners
        function setupFirebaseListeners() {
            // Listen to participants
            const participantsRef = database.ref(`rooms/${ROOM_ID}/participants`);
            participantsRef.on('value', (snapshot) => {
                updateParticipants(snapshot.val());
            });
            
            // Listen to join requests (only for owners/admins)
            if (userRole === 'owner' || userRole === 'admin') {
                const requestsRef = database.ref(`rooms/${ROOM_ID}/requests`);
                requestsRef.on('child_added', (snapshot) => {
                    const request = snapshot.val();
                    if (request.id !== userId) {
                        showJoinRequest(request, snapshot.key);
                    }
                });
            }
            
            // Listen to messages
            const messagesRef = database.ref(`rooms/${ROOM_ID}/messages`);
            messagesRef.limitToLast(50).on('value', (snapshot) => {
                updateMessages(snapshot.val());
            });
            
            // Listen to room status
            const roomRef = database.ref(`rooms/${ROOM_ID}`);
            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (room && room.status === 'ended') {
                    handleRoomEnded();
                }
            });
            
            // Listen to WebRTC signaling
            const signalingRef = database.ref(`rooms/${ROOM_ID}/signaling/${userId}`);
            signalingRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    handleSignaling(data, data.from);
                    // Clear signaling data
                    setTimeout(() => signalingRef.remove(), 1000);
                }
            });
        }

        // Setup Existing Connections
        async function setupExistingConnections() {
            const participantsRef = database.ref(`rooms/${ROOM_ID}/participants`);
            const snapshot = await participantsRef.once('value');
            const participants = snapshot.val() || {};
            
            Object.values(participants).forEach(async (participant) => {
                if (participant.id !== userId && (participant.role === 'owner' || participant.role === 'admin' || participant.role === 'main-speaker')) {
                    await createPeerConnection(participant.id, false);
                }
            });
        }

        // Create Peer Connection
        async function createPeerConnection(peerId, isInitiator = true) {
            if (peers.has(peerId)) return;
            
            try {
                const peer = new SimplePeer({
                    initiator: isInitiator,
                    stream: localStream,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('signal', async (data) => {
                    const signalingRef = database.ref(`rooms/${ROOM_ID}/signaling/${peerId}`);
                    await signalingRef.set({
                        from: userId,
                        signal: data,
                        timestamp: Date.now()
                    });
                });
                
                peer.on('stream', (stream) => {
                    handleRemoteStream(peerId, stream);
                });
                
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    peers.delete(peerId);
                });
                
                peer.on('close', () => {
                    peers.delete(peerId);
                });
                
                peers.set(peerId, peer);
                
            } catch (error) {
                console.error('Peer creation error:', error);
            }
        }

        // Handle Remote Stream
        function handleRemoteStream(peerId, stream) {
            // Create audio element
            const audio = new Audio();
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.volume = 0.8;
            
            // Setup audio analysis for visualization
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            const analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);
            
            // Store analyser for this peer
            if (!window.peerAnalysers) window.peerAnalysers = new Map();
            window.peerAnalysers.set(peerId, analyser);
            
            // Update speaking status
            updateSpeakingVisualization(peerId, analyser);
        }

        // Update Speaking Visualization
        function updateSpeakingVisualization(peerId, analyser) {
            function checkSpeaking() {
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                const isSpeaking = average > 20; // Threshold for speaking
                
                // Update in Firebase
                const userRef = database.ref(`rooms/${ROOM_ID}/participants/${peerId}/isSpeaking`);
                userRef.set(isSpeaking);
                
                // Update audio level in UI
                const level = Math.min(100, (average / 128) * 100);
                const levelElement = document.getElementById(`audio-level-${peerId}`);
                if (levelElement) {
                    levelElement.style.width = `${level}%`;
                }
                
                requestAnimationFrame(checkSpeaking);
            }
            
            checkSpeaking();
        }

        // Handle Signaling
        async function handleSignaling(data, fromPeerId) {
            const peer = peers.get(fromPeerId);
            if (peer) {
                peer.signal(data.signal);
            } else {
                await createPeerConnection(fromPeerId, false);
                setTimeout(() => {
                    const newPeer = peers.get(fromPeerId);
                    if (newPeer) newPeer.signal(data.signal);
                }, 500);
            }
        }

        // Update Participants
        function updateParticipants(participants) {
            if (!participants) participants = {};
            
            // Sort participants by role: owner -> admin -> main-speaker -> guest
            const participantsArray = Object.values(participants).sort((a, b) => {
                const roleOrder = { owner: 0, admin: 1, 'main-speaker': 2, guest: 3 };
                return roleOrder[a.role] - roleOrder[b.role];
            });
            
            updateParticipantsGrid(participantsArray);
            
            if (userRole === 'owner' || userRole === 'admin') {
                updateParticipantsList(participantsArray);
            }
        }

        // Update Participants Grid
        function updateParticipantsGrid(participants) {
            participantsGrid.innerHTML = '';
            
            participants.forEach(participant => {
                // Don't show yourself if you're a guest viewing
                if (participant.id === userId && userRole === 'guest') return;
                
                const card = document.createElement('div');
                card.className = `participant-card ${participant.role} ${participant.isSpeaking ? 'speaking' : ''}`;
                card.id = `participant-card-${participant.id}`;
                
                card.innerHTML = `
                    <div class="participant-bg" style="background-image: url('${participant.photo}')"></div>
                    <div class="participant-content">
                        <img src="${participant.photo}" alt="${participant.name}" class="participant-avatar">
                        <div class="participant-name">${participant.name}</div>
                        <div class="participant-role">
                            <i class='bx ${getRoleIcon(participant.role)}'></i>
                            ${participant.role === 'main-speaker' ? 'Main Speaker' : participant.role.toUpperCase()}
                        </div>
                        <div class="audio-indicator">
                            <div class="audio-level" id="audio-level-${participant.id}"></div>
                        </div>
                    </div>
                `;
                
                participantsGrid.appendChild(card);
            });
        }

        // Update Participants List
        function updateParticipantsList(participants) {
            sidebarContent.innerHTML = '';
            
            const list = document.createElement('div');
            list.className = 'participants-list';
            
            participants.forEach(participant => {
                const item = document.createElement('div');
                item.className = `participant-item ${participant.isSpeaking ? 'speaking' : ''}`;
                
                let actions = '';
                if (participant.id !== userId) {
                    actions = `
                        <div class="participant-actions">
                            ${participant.role !== 'owner' ? `
                                <button class="btn-icon" onclick="removeParticipant('${participant.id}')" title="Remove">
                                    <i class='bx bx-user-x'></i>
                                </button>
                            ` : ''}
                            ${userRole === 'owner' && participant.role === 'guest' ? `
                                <button class="btn-icon" onclick="makeAdmin('${participant.id}')" title="Make Admin">
                                    <i class='bx bx-user-plus'></i>
                                </button>
                            ` : ''}
                            ${(userRole === 'owner' || userRole === 'admin') && participant.role === 'guest' ? `
                                <button class="btn-icon" onclick="makeSpeaker('${participant.id}')" title="Make Main Speaker">
                                    <i class='bx bx-microphone'></i>
                                </button>
                            ` : ''}
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <img src="${participant.photo}" alt="${participant.name}" class="participant-item-avatar">
                    <div class="participant-item-info">
                        <div class="participant-item-name">${participant.name}</div>
                        <div class="participant-item-role">
                            <i class='bx ${getRoleIcon(participant.role)}'></i>
                            ${participant.role === 'main-speaker' ? 'Main Speaker' : participant.role.toUpperCase()}
                            ${participant.isSpeaking ? '  Speaking' : ''}
                        </div>
                    </div>
                    ${actions}
                `;
                
                list.appendChild(item);
            });
            
            sidebarContent.appendChild(list);
        }

        // Get Role Icon
        function getRoleIcon(role) {
            switch(role) {
                case 'owner': return 'bx-crown';
                case 'admin': return 'bx-shield';
                case 'main-speaker': return 'bx-microphone';
                default: return 'bx-user';
            }
        }

        // Update UI
        function updateUI() {
            currentUserAvatar.src = userData.photo;
            currentUserName.textContent = userData.name;
            currentUserRole.textContent = userRole.toUpperCase();
            currentUserRole.className = `user-badge ${userRole}`;
            
            // Update mute button
            updateMuteButton();
            
            // Show/hide admin controls
            if (userRole === 'owner' || userRole === 'admin') {
                adminControls.style.display = 'flex';
            } else {
                adminControls.style.display = 'none';
            }
        }

        // Update Mute Button
        function updateMuteButton() {
            const icon = muteBtn.querySelector('i');
            if (isMuted) {
                icon.className = 'bx bx-microphone-off';
                muteBtn.title = 'Unmute';
            } else {
                icon.className = 'bx bx-microphone';
                muteBtn.title = 'Mute';
            }
        }

        // Toggle Mute
        function toggleMute() {
            if (!localStream) return;
            
            const audioTrack = localStream.getAudioTracks()[0];
            isMuted = !isMuted;
            audioTrack.enabled = !isMuted;
            
            // Update in Firebase
            const userRef = database.ref(`rooms/${ROOM_ID}/participants/${userId}/isMuted`);
            userRef.set(isMuted);
            
            updateMuteButton();
            showNotification(isMuted ? 'You are muted' : 'You are unmuted', 'info');
        }

        // Show Join Request
        function showJoinRequest(request, requestId) {
            currentRequest = { ...request, requestId };
            
            requesterAvatar.src = request.photo;
            requesterName.textContent = request.name;
            joinRequestModal.classList.add('active');
        }

        // Handle Join Request Response
        async function handleJoinRequestResponse(accept) {
            if (!currentRequest) return;
            
            const requestRef = database.ref(`rooms/${ROOM_ID}/requests/${currentRequest.id}`);
            
            if (accept) {
                // Accept request
                await requestRef.update({ status: 'accepted' });
                
                // Add user to participants
                const userRef = database.ref(`rooms/${ROOM_ID}/participants/${currentRequest.id}`);
                await userRef.set({
                    ...currentRequest,
                    role: 'guest',
                    isSpeaking: false,
                    isMuted: false,
                    joinedAt: Date.now()
                });
                
                showNotification(`${currentRequest.name} joined the call`, 'success');
                
            } else {
                // Reject request
                await requestRef.update({ status: 'rejected' });
                showNotification(`${currentRequest.name} was rejected`, 'warning');
            }
            
            joinRequestModal.classList.remove('active');
            currentRequest = null;
        }

        // Remove Participant
        async function removeParticipant(participantId) {
            if (userRole !== 'owner' && userRole !== 'admin') return;
            
            const userRef = database.ref(`rooms/${ROOM_ID}/participants/${participantId}`);
            const snapshot = await userRef.once('value');
            const participant = snapshot.val();
            
            if (!participant) return;
            
            if (userRole === 'admin' && (participant.role === 'owner' || participant.role === 'admin')) {
                showNotification('Admins can only remove guests and speakers', 'error');
                return;
            }
            
            await userRef.remove();
            showNotification(`${participant.name} removed from call`, 'success');
        }

        // Make Admin
        async function makeAdmin(participantId) {
            if (userRole !== 'owner') {
                showNotification('Only owner can assign admins', 'error');
                return;
            }
            
            const userRef = database.ref(`rooms/${ROOM_ID}/participants/${participantId}`);
            await userRef.update({ role: 'admin' });
            showNotification('User promoted to admin', 'success');
        }

        // Make Speaker
        async function makeSpeaker(participantId) {
            if (userRole !== 'owner' && userRole !== 'admin') {
                showNotification('Only owner/admin can assign speakers', 'error');
                return;
            }
            
            const userRef = database.ref(`rooms/${ROOM_ID}/participants/${participantId}`);
            await userRef.update({ role: 'main-speaker' });
            showNotification('User promoted to main speaker', 'success');
        }

        // End Call
        async function endCall() {
            endCallModal.classList.remove('active');
            
            const roomRef = database.ref(`rooms/${ROOM_ID}`);
            await roomRef.update({
                status: 'ended',
                endedAt: Date.now(),
                endedBy: userId
            });
            
            showNotification('Conference ended for all participants', 'success');
            cleanup();
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        // Leave Call
        async function leaveCall() {
            leaveCallModal.classList.remove('active');
            
            // Remove user from participants
            const userRef = database.ref(`rooms/${ROOM_ID}/participants/${userId}`);
            await userRef.remove();
            
            cleanup();
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // Handle Room Ended
        function handleRoomEnded() {
            showNotification('Conference ended by host', 'warning');
            cleanup();
            
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }

        // Cleanup
        function cleanup() {
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // Close audio context
            if (audioContext) {
                audioContext.close();
            }
            
            // Close peer connections
            peers.forEach(peer => {
                try {
                    peer.destroy();
                } catch (e) {}
            });
            peers.clear();
        }

        // Update Messages
        function updateMessages(messages) {
            if (!messages) return;
            
            // Implement if needed
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class='bx bx-${type === 'error' ? 'error' : type === 'success' ? 'check' : 'info-circle'}'></i>
                    <div>${message}</div>
                </div>
            `;
            
            notificationContainer.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Event Listeners
        muteBtn.addEventListener('click', toggleMute);
        
        participantsBtn.addEventListener('click', () => {
            sidebarTitle.textContent = 'Participants';
            appSidebar.classList.add('active');
        });
        
        messagesBtn.addEventListener('click', () => {
            sidebarTitle.textContent = 'Messages';
            appSidebar.classList.add('active');
        });
        
        closeSidebarBtn.addEventListener('click', () => {
            appSidebar.classList.remove('active');
        });
        
        endCallBtn.addEventListener('click', () => {
            if (userRole !== 'owner' && userRole !== 'admin') {
                showNotification('Only hosts can end the conference', 'error');
                return;
            }
            endCallModal.classList.add('active');
        });
        
        leaveBtn.addEventListener('click', () => {
            leaveCallModal.classList.add('active');
        });
        
        cancelEndCallBtn.addEventListener('click', () => {
            endCallModal.classList.remove('active');
        });
        
        confirmEndCallBtn.addEventListener('click', endCall);
        
        cancelLeaveBtn.addEventListener('click', () => {
            leaveCallModal.classList.remove('active');
        });
        
        confirmLeaveBtn.addEventListener('click', leaveCall);
        
        rejectRequestBtn.addEventListener('click', () => {
            handleJoinRequestResponse(false);
        });
        
        acceptRequestBtn.addEventListener('click', () => {
            handleJoinRequestResponse(true);
        });

        // Global functions for onclick events
        window.removeParticipant = removeParticipant;
        window.makeAdmin = makeAdmin;
        window.makeSpeaker = makeSpeaker;

        // Initialize
        document.addEventListener('DOMContentLoaded', initApp);

        // Handle beforeunload
        window.addEventListener('beforeunload', () => {
            if (userId && isInCall) {
                const userRef = database.ref(`rooms/${ROOM_ID}/participants/${userId}`);
                userRef.remove();
            }
            cleanup();
        });

    </script>
</body>
</html>
